{% extends "utilities/base.html" %}

{% block content %}

{% for instance in instances %}
	<div class="tile">
		{% if instance.thumbnail %}
		<img id='{{instance.identifier}}' class="tile-img" src="{{instance.thumbnail.url}}" alt="" 
			onclick="display_large_image('{{instance.identifier}}')"> 
		{% else %}
		<img id='{{instance.identifier}}' class="tile-img op" src="media/no_image_available.png" alt="" 
			onclick="display_large_image('{{instance.identifier}}')"> 
		{% endif %}
		<p class="p-title">
			<i class="{{instance.icon}} fa-lg" aria-hidden="true"></i>
			<a 
				href = "{% url instance.edit_url instance.pk %}"
				role = "button">
				{{instance.title|truncatechars:31}}
			</a>
		</p>
	</div>
{% endfor %}

<div class="modal" id="myModal">
  <!-- Modal content -->

	<div class="grid-container"> 
		<div class="grid-item">
			<i id="modal-icon" class="" style="color:white;"></i>
		</div>
		<div class="grid-item">
			<a id="prev_modal" class="prev_next_modal prev_modal" href="#" role = "button">
				<i class="fas fa-chevron-left"></i>
			</a>
		</div>
		<div class="grid-item">
			<a id="next_modal" class="prev_next_modal" href="#" role = "button">
				<i class="fas fa-chevron-right"></i>
			</a>
		</div>
		<div class="grid-item">
			<a id="close_modal" class="close_modal" onclick="return false;" href="#/" role = "button">
				<span class="close">&times;</span>
			</a>
		</div>
	</div>

  <div class="modal-content">
	<img id="modal-img" class="big-img" src="" alt="media/no_image_available.png">

	<a  id="modal-edit-link" class="modal-edit-link"
		href = ""
		role = "button">
			<p id="modal-title" class="modal-title">
			Some text in the Modal..</p>
	</a>
	<p id="modal-date" class="modal-date">Some text in the Modal..
	</p>
  </div>

  <div>
	<!-- <i class="fas fa-circle" style="color:white;"></i> -->
	<p id="one_of_x" class = 'one_of_x'></p>
  </div>

</div>

<script>
document.onkeydown = checkKey;

function checkKey(e) {
	//handle keyboard input, escape key to exit model
	//right and down arrow keys to go forward
	//left and up arrow keys to go back
	e = e || window.event;
	var direction = ''
	if (e.keyCode == 27) {
		modal.style.display = "none";
		in_modal_state = false;
	} else if (e.keyCode == 37 || e.keyCode == 38) {
		next_prev_picture('back')
	} else if (e.keyCode == 39 || e.keyCode == 40) {
		next_prev_picture('forward')
	}
	console.log(e.keyCode);
}

function next_prev_picture(direction) {
	if (!in_modal_state) {return}
	i = find_identifier_index(current_img_identifier);
	console.log('next_prev_picture');
	if (direction == 'back' || direction == 'prev') {
		if (i == 0) {i = tiles.length -1;}
		else { i -= 1;}
	}
	if (direction == 'forward' || direction == 'next') {
		if (i == tiles.length -1) { i = 0; }
		else { i += 1;}
	}
	console.log(i)
	display_large_image(tiles[i].id);
}


var tiles= document.getElementsByClassName('tile-img')
for ( i =0; i < tiles.length; i++ ){
	tile= tiles[i];
	//console.log(tile);
}

function find_identifier_index(identifier) {
	for ( i =0; i < tiles.length; i++ ){
		tile= tiles[i];
		//console.log(tile);
		if (tile.id == identifier) {return i;}
	}
}
	
// whether the large image is shown in the modal
var in_modal_state = false;
// identifier of the instance of which the image is shown
var current_img_identifier= '';
// Get the modal
var modal = document.getElementById("myModal");
//elements that display the image, title and date
var modal_title = document.getElementById("modal-title");
var modal_icon= document.getElementById("modal-icon");
var modal_img= document.getElementById("modal-img");
var modal_date= document.getElementById("modal-date");
var modal_edit= document.getElementById("modal-edit-link");
// Get the <span> element that closes the modal, OBSOLETE??
var span = document.getElementsByClassName("close")[0];
var close_modal= document.getElementById("close_modal");
var prev_modal= document.getElementById("prev_modal");
var next_modal= document.getElementById("next_modal");
var image_reel_on = false;
var one_of_x = document.getElementById('one_of_x');

async function get_instance_info(identifier,fields= false) {
	//gets information of an instance, instance is loaded based on 
	//the identifier field
	//fields 	the field names the info should be gathered from
	// 			false or 'all' returns the dict of the instance (not property values)
	//returns a dictionary of field name field info or a json representation of the instance
	var url = '/utilities/ajax_instance_info/' + identifier 
	if (fields) { url += '/' + fields ;}
	const response = await fetch(url); 
	const instance_info = await response.json();
	return instance_info;
}

async function display_large_image(identifier) {
	//displays large image of a given instance (identified with identifier)
	image_reel_on = false;
	one_of_x.innerText= '';
	fields = 'thumbnail,edit_url,title,pk,date,icon,image_urls'
	var d  = await get_instance_info(identifier,fields)
	in_modal_state = true;
	current_img_identifier = identifier;
	modal_title.innerText = d['title'];
	//console.log(modal_icon);
	modal_icon.className=d['icon'] + ' fa-2x modal-icon';
	//console.log(modal_icon);
	modal_date.innerText = d['date'];
	image_urls = get_image_urls(d['image_urls'].split(','));
	if (image_urls.length > 0) {image_url = '/media/' +image_urls[0];}
	else { image_url = '/media/' + d['thumbnail'];}
	modal_img.src = image_url
	modal_edit.href = "/" +d['edit_url'].replace(':','/') + "/" + d['pk'] + "/"
	modal.style.display = "block";
	if (image_urls.length > 1) {
			one_of_x.innerText= 1 + '/' + image_urls.length;
			setTimeout(switch_images,2100,image_urls,image_urls[0],identifier)
			image_reel_on = true;
	}
	
}

function get_image_urls(image_urls) {
	//remove thumbnail image from image_urls
	var output = [];
	for (i = 0; i < image_urls.length; i++) {
		url = image_urls[i];
		if (!(url.includes('thumbnail'))) {output.push(url);}
	}
	return output
}

function switch_images(image_urls,current_image, identifier) {
	console.log(image_urls,current_image,image_reel_on);
	var next_modal= document.getElementById("");
	var index = 0;
	if (in_modal_state && image_reel_on && current_img_identifier == identifier) {
		for ( i =0; i < image_urls.length; i++ ){
			url= image_urls[i];
			if (url  == current_image) {
				console.log(url,i,image_urls.length, i == (image_urls.length -1));
				if (i == (image_urls.length -1)) {index = 0;}
				else {index = i + 1;}
				console.log(index)
				modal_img.src = '/media/' +image_urls[index]
			}
		}
		console.log(image_urls,image_urls[index],index);
		one_of_x.innerText= (index +1) + '/' + image_urls.length;
		
		setTimeout(switch_images,3000,image_urls,image_urls[index],identifier);
	}
}


close_modal.onclick = function() {
	modal.style.display = "none";
	in_modal_state = false;
}

prev_modal.onclick = function() {
	next_prev_picture('prev');
}
next_modal.onclick = function() {
	console.log('hello');
	next_prev_picture('next');
}

</script>

<style>

.grid-container {
	display:grid;
	grid-template-columns: 2fr 1fr 1fr 2fr;
	padding: 1px;
	grid-gap: 3px;
	justify-items: center;
	align-items: end;
}

.grid-item {
	/*background-color: #f0f0f0;*/
	padding: 0px;
	text-align: justify;
}


/* The Modal (background) */
.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.85); /* Black w/ opacity */
}

/* Modal Content/Box */
.modal-content {
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.45); /* Black w/ opacity */
  margin-left: auto; /* 15% from the top and centered */
  margin-right: auto; /* 15% from the top and centered */
  margin-top: 2%; /* 15% from the top and centered */
  padding: 20px;
  width: 90%; /* Could be more or less, depending on screen size */
  height: 75%; /* Could be more or less, depending on screen size */
}

.one_of_x {
	color: white;
	float:right;
	padding-right:50px;
}

/* The Close Button */
.close {
    color: rgba(10,10,10,0.03); /* Black w/ opacity */
	padding-right:50px;
	font-size:300%;
}

.prev_next_modal{
	padding-right:30px;
    color: rgba(255,255,255,0.6);
	font-size:200%;
}
.prev_modal{
	margin-left:40%;
}

.prev_next_modal:hover {
    color: rgba(255,255,255,0.9);
}


.close:hover,
.close:focus {
  color: rgba(255,255,255,0.45); /* Black w/ opacity */
  text-decoration: none;
  cursor: pointer;
}

.close_modal {
	margin-top:15px;
	padding-right;50px;
}

.modal-title {
	color:white;
	font-size: 150%;
	justify:center;
	margin-left:auto;
	margin-right:auto;
	margin-top:auto;
}

.modal-edit-link{
	justify:center;
	margin-left:auto;
	margin-right:auto;
}


.modal-date{
	color:grey;
	font-size: 80%;
	justify:center;
	margin-left:auto;
	margin-right:auto;
	margin-top:auto;
	margin-bottom:0px;
}

.modal-icon{
	color:white;
	justify:center;
	margin-left:50px;
	margin-right:auto;
	margin-top:30px;
	margin-bottom:0px;
}


.tile {
	display:inline-block;
	height:250px;
	width:250px;
	background-color: #f0f0f0;
	margin-top:5px;
	margin-left:3px;
}

.big-img {
	display: block;
	margin-left: auto;
	margin-right: auto;
	margin-top: auto;
	margin-bottom: auto;
	height:90%;
	width:auto;
	max-width:100%;
	margin:0px
	object-fit:contain;
	justify:center;
}

.op {
	opacity: 0.05;
}

img {
	border-radius:8px;
	width:240px;
	height:210px;
	object-fit:cover;
	padding:0px;
	margin:5px
}

i {
	margin-left:5px;
}

a {
	display:inline-block;
	color:black;
	margin-left:5px;
}

p {
	font-family: "Georgia", serif;
	font-size: small;
	margin-top: 3px;
}

</style>

{% endblock %}

